<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced 3x5 Index Card Creator</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Caveat&family=Courier+Prime&family=Dancing+Script&family=EB+Garamond&family=Indie+Flower&family=Lato&family=Montserrat&family=Open+Sans&family=Patrick+Hand&family=Roboto&family=Roboto+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --card-bg: #fffdf5;
            --handle-hover: #4CAF50;
            /* UI Scale: Bigger on screen for readability */
            --ui-width: 600px;
            --ui-height: 360px; /* 5:3 Ratio */
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #555;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        /* --- Toolbar --- */
        #toolbar {
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            position: sticky;
            top: 20px;
            z-index: 1000;
        }

        .tool-group {
            display: flex;
            gap: 5px;
            align-items: center;
            padding-right: 15px;
            border-right: 1px solid #ddd;
        }
        .tool-group:last-child { border-right: none; }

        button, select, input {
            cursor: pointer;
            padding: 6px 10px;
            border: 1px solid #ccc;
            background: #f9f9f9;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover { background: #eee; }
        
        .side-toggle button { font-weight: bold; color: #666; }
        .side-toggle button.active { background: #333; color: white; border-color: #333; }

        button.primary-btn { background-color: #007bff; color: white; border-color: #0069d9; font-weight: bold; }
        button.primary-btn:hover { background-color: #0056b3; }

        button.danger-btn { background-color: #dc3545; color: white; border-color: #dc3545; }
        button.danger-btn:hover { background-color: #c82333; }

        /* --- Editor Stage --- */
        #editor-stage {
            width: var(--ui-width);
            height: var(--ui-height);
            position: relative;
        }

        .card-face {
            width: 100%;
            height: 100%;
            background-color: var(--card-bg);
            position: absolute;
            top: 0; left: 0;
            display: flex;
            border: 1px solid #999;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        .card-face.hidden { display: none; }

        /* --- Flex Grid System --- */
        .split-container {
            display: flex;
            flex: 1;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .split-container.horizontal { flex-direction: row; }
        .split-container.vertical { flex-direction: column; }

        .leaf {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            min-width: 0; min-height: 0;
            border: 1px dotted rgba(0,0,0,0.1); 
        }
        .leaf:hover { border-color: #888; }

        .editor {
            flex: 1;
            padding: 10px;
            outline: none;
            overflow: hidden; 
            line-height: 1.3;
            color: black;
        }

        /* --- Controls --- */
        .leaf-controls {
            position: absolute; top: 0; right: 0;
            display: flex; opacity: 0;
            background: white; border: 1px solid #ccc;
            z-index: 10;
        }
        .leaf:hover .leaf-controls { opacity: 1; }
        .control-btn { font-size: 12px; padding: 2px 6px; border: none; border-right: 1px solid #eee; background: white; }
        .control-btn.close { color: red; }

        .resizer {
            background-color: transparent;
            z-index: 5;
            flex: 0 0 8px;
            position: relative;
        }
        .split-container.horizontal > .resizer { cursor: col-resize; width: 8px; margin: 0 -4px; z-index: 6; }
        .split-container.vertical > .resizer { cursor: row-resize; height: 8px; margin: -4px 0; z-index: 6; }
        .resizer:hover, .resizer.resizing { background-color: var(--handle-hover); opacity: 0.5; }

        /* --- PRINT STYLES --- */
        #print-area { display: none; }

        @media print {
            body * { visibility: hidden; }
            #toolbar, #editor-stage { display: none; }
            #print-area {
                display: block !important;
                visibility: visible !important;
                position: absolute; top: 0; left: 0; width: 100%;
            }
            #print-area * { visibility: visible !important; }
            @page { size: 5in 3in; margin: 0; }
            .print-page {
                width: 5in; height: 3in;
                position: relative; overflow: hidden; display: flex;
                background: white; page-break-after: always; break-after: page;
            }
            .leaf-controls, .resizer { display: none !important; }
            .leaf { border: none !important; }
            .editor { padding: 0.1in; }
        }
    </style>
</head>
<body>

    <div id="toolbar">
        <div class="tool-group">
            <div class="side-toggle">
                <button id="btn-front" class="active" onclick="switchSide('front')">FRONT</button>
                <button id="btn-back" onclick="switchSide('back')">BACK</button>
            </div>
        </div>

        <div class="tool-group">
            <select id="fontSelect" onchange="applyFormat('fontName', this.value)">
                <option value="Arial">Arial</option>
                <option value="'Courier Prime', monospace">Courier</option>
                <option value="'Roboto', sans-serif">Roboto</option>
                <option value="'Open Sans', sans-serif">Open Sans</option>
                <option value="'Caveat', cursive">Caveat</option>
                <option value="'Indie Flower', cursive">Indie Flower</option>
                <option value="'EB Garamond', serif">Garamond</option>
            </select>
            
            <label style="font-size:12px; font-weight:bold;">Size:</label>
            <input type="number" id="fontSizeInput" value="14" min="6" max="72" style="width:50px" onchange="updateFontSize(this.value)">
        </div>

        <div class="tool-group">
            <button onclick="applyFormat('bold')"><b>B</b></button>
            <button onclick="applyFormat('italic')"><i>I</i></button>
            <button onclick="applyFormat('underline')"><u>U</u></button>
            <button onclick="applyFormat('insertUnorderedList')">• List</button>
        </div>

        <div class="tool-group">
            <button class="danger-btn" onclick="confirmReset()" title="Remove all subdivisions and text from current side">Clear All Subdivisions</button>
        </div>

        <div class="tool-group" style="border:none">
            <button class="primary-btn" onclick="prepareAndPrint()">Print / Save as PDF</button>
        </div>
    </div>

    <!-- The Screen Editor -->
    <div id="editor-stage">
        <div id="card-front" class="card-face">
            <div class="leaf">
                <div class="leaf-controls">
                    <button class="control-btn" onclick="splitQuad(this)" title="Split Both (2x2 Grid)">⊞</button>
                    <button class="control-btn" onclick="split(this, 'horizontal')" title="Split Horizontal">||</button>
                    <button class="control-btn" onclick="split(this, 'vertical')" title="Split Vertical">=</button>
                </div>
                <div class="editor" contenteditable="true" style="font-family: Arial; font-size: 14px;">Front Side Content...</div>
            </div>
        </div>
        <div id="card-back" class="card-face hidden">
            <div class="leaf">
                <div class="leaf-controls">
                    <button class="control-btn" onclick="splitQuad(this)" title="Split Both (2x2 Grid)">⊞</button>
                    <button class="control-btn" onclick="split(this, 'horizontal')" title="Split Horizontal">||</button>
                    <button class="control-btn" onclick="split(this, 'vertical')" title="Split Vertical">=</button>
                </div>
                <div class="editor" contenteditable="true" style="font-family: Arial; font-size: 14px;">Back Side Content...</div>
            </div>
        </div>
    </div>

    <!-- The Print Container (Hidden until print) -->
    <div id="print-area"></div>

    <script>
        let currentEditor = null;
        let activeSide = 'front';

        document.addEventListener('DOMContentLoaded', () => {
            attachEvents();
            const first = document.querySelector('#card-front .editor');
            if(first) first.focus();
        });

        function attachEvents() {
            document.querySelectorAll('.editor').forEach(ed => {
                ed.addEventListener('focus', e => {
                    currentEditor = e.target;
                    const size = parseInt(window.getComputedStyle(currentEditor).fontSize);
                    document.getElementById('fontSizeInput').value = size;
                });
                ed.addEventListener('click', e => currentEditor = e.target);
            });
        }

        // --- Layout Logic ---
        function switchSide(side) {
            activeSide = side;
            document.getElementById('card-front').classList.toggle('hidden', side !== 'front');
            document.getElementById('card-back').classList.toggle('hidden', side !== 'back');
            document.getElementById('btn-front').classList.toggle('active', side === 'front');
            document.getElementById('btn-back').classList.toggle('active', side === 'back');
        }

        function applyFormat(cmd, val) {
            document.execCommand(cmd, false, val);
            if(currentEditor) currentEditor.focus();
        }

        function updateFontSize(px) {
            if(currentEditor) currentEditor.style.fontSize = px + 'px';
        }

        // Helper to generate resizers
        function createResizer() {
            const r = document.createElement('div');
            r.className = 'resizer';
            initResizer(r);
            return r;
        }

        // --- SPLIT QUAD (BOTH) ---
        function splitQuad(btn) {
            const leaf = btn.closest('.leaf');
            const parent = leaf.parentElement;
            const ed = leaf.querySelector('.editor');

            // Save attributes
            const html = ed.innerHTML;
            const font = window.getComputedStyle(ed).fontFamily;
            const size = window.getComputedStyle(ed).fontSize;

            // Structure: Vertical Container holds [Horizontal Top Row] + Resizer + [Horizontal Bottom Row]
            
            // 1. Root Vertical
            const root = document.createElement('div');
            root.className = 'split-container vertical';

            // 2. Top Row (Horizontal)
            const topRow = document.createElement('div');
            topRow.className = 'split-container horizontal';
            topRow.style.flex = "1";

            // 3. Bottom Row (Horizontal)
            const botRow = document.createElement('div');
            botRow.className = 'split-container horizontal';
            botRow.style.flex = "1";

            // 4. Create 4 Leaves
            const l1 = createLeaf(html, font, size); // Top-Left (Keeps content)
            const l2 = createLeaf('', font, size);   // Top-Right
            const l3 = createLeaf('', font, size);   // Bot-Left
            const l4 = createLeaf('', font, size);   // Bot-Right

            // 5. Assemble Top Row (Leaf | Res | Leaf)
            topRow.appendChild(l1);
            topRow.appendChild(createResizer());
            topRow.appendChild(l2);

            // 6. Assemble Bottom Row (Leaf | Res | Leaf)
            botRow.appendChild(l3);
            botRow.appendChild(createResizer());
            botRow.appendChild(l4);

            // 7. Assemble Root (Top | Res | Bot)
            root.appendChild(topRow);
            root.appendChild(createResizer());
            root.appendChild(botRow);

            if(parent.classList.contains('card-face')) {
                parent.innerHTML = '';
                parent.append(root);
            } else {
                parent.replaceChild(root, leaf);
            }
            attachEvents();
        }

        // --- SPLIT SINGLE (HORIZONTAL OR VERTICAL) ---
        function split(btn, dir) {
            const leaf = btn.closest('.leaf');
            const parent = leaf.parentElement;
            const ed = leaf.querySelector('.editor');
            
            const html = ed.innerHTML;
            const font = window.getComputedStyle(ed).fontFamily;
            const size = window.getComputedStyle(ed).fontSize;

            const container = document.createElement('div');
            container.className = `split-container ${dir}`;

            const l1 = createLeaf(html, font, size);
            const l2 = createLeaf('', font, size);
            
            container.append(l1, createResizer(), l2);
            
            if(parent.classList.contains('card-face')) {
                parent.innerHTML = '';
                parent.append(container);
            } else {
                parent.replaceChild(container, leaf);
            }
            attachEvents();
        }

        function createLeaf(content, font, size) {
            const div = document.createElement('div');
            div.className = 'leaf';
            div.innerHTML = `
                <div class="leaf-controls">
                    <button class="control-btn" onclick="splitQuad(this)" title="Split Both (2x2 Grid)">⊞</button>
                    <button class="control-btn" onclick="split(this, 'horizontal')" title="Split Horizontal">||</button>
                    <button class="control-btn" onclick="split(this, 'vertical')" title="Split Vertical">=</button>
                    <button class="control-btn close" onclick="removeBlock(this)" title="Remove Block">✕</button>
                </div>
                <div class="editor" contenteditable="true" spellcheck="false" style="font-family:${font}; font-size:${size}">${content}</div>
            `;
            return div;
        }

        function removeBlock(btn) {
            const leaf = btn.closest('.leaf');
            const container = leaf.parentElement;
            const grand = container.parentElement;

            let sibling;
            Array.from(container.children).forEach(c => {
                if(c !== leaf && !c.classList.contains('resizer')) sibling = c;
            });

            if(!sibling) { confirmReset(); return; }

            if(grand.classList.contains('card-face')) {
                grand.innerHTML = '';
                grand.append(sibling);
            } else {
                grand.replaceChild(sibling, container);
            }
        }

        function confirmReset() {
            if(confirm("Are you sure you want to clear all subdivisions on this side? This will delete the current layout and text.")) {
                resetCurrentSide();
            }
        }

        function resetCurrentSide() {
            const id = activeSide === 'front' ? 'card-front' : 'card-back';
            const face = document.getElementById(id);
            face.innerHTML = '';
            const l = createLeaf('Type here...', 'Arial', '14px');
            l.querySelector('.close').remove();
            face.append(l);
            attachEvents();
        }

        // --- Resizer ---
        function initResizer(resizer) {
            let x, y, prev, next, wP, hP, wN, hN;
            const md = (e) => {
                x = e.clientX; y = e.clientY;
                prev = resizer.previousElementSibling;
                next = resizer.nextElementSibling;
                const rP = prev.getBoundingClientRect();
                const rN = next.getBoundingClientRect();
                wP = rP.width; hP = rP.height; wN = rN.width; hN = rN.height;
                
                resizer.classList.add('resizing');
                document.addEventListener('mousemove', mm);
                document.addEventListener('mouseup', mu);
            };
            const mm = (e) => {
                const isHoriz = resizer.parentElement.classList.contains('horizontal');
                if(isHoriz) {
                    const dx = e.clientX - x;
                    prev.style.flex = `0 0 ${wP + dx}px`;
                    next.style.flex = `0 0 ${wN - dx}px`;
                } else {
                    const dy = e.clientY - y;
                    prev.style.flex = `0 0 ${hP + dy}px`;
                    next.style.flex = `0 0 ${hN - dy}px`;
                }
            };
            const mu = () => {
                resizer.classList.remove('resizing');
                document.removeEventListener('mousemove', mm);
                document.removeEventListener('mouseup', mu);
            };
            resizer.addEventListener('mousedown', md);
        }

        // --- Print Logic ---
        function prepareAndPrint() {
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = ''; 

            const frontClone = document.getElementById('card-front').cloneNode(true);
            frontClone.removeAttribute('id');
            frontClone.className = 'print-page'; 
            
            const backClone = document.getElementById('card-back').cloneNode(true);
            backClone.removeAttribute('id');
            backClone.className = 'print-page';
            
            printArea.appendChild(frontClone);
            printArea.appendChild(backClone);

            window.print();
        }
    </script>
</body>
</html>